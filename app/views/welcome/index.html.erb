<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h5>Cotizaciones Mensuales<br><small>últimos doce meses</small></h5>
        </div>
        <div id="call-chart" style="width: 100%; height: 350px"></div>
    </div>
</div>

<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h5>Servicios Mensuales<br><small>últimos doce meses</small></h5>
        </div>
        <div id="services-chart" style="width: 100%; height: 350px"></div>
    </div>
</div>

<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h5>Gastos</h5>
        </div>
        <div class="card-block">
            <div id="chart-line-1" class="lineChart2 ChartShadow" style="height:350px;"></div>
        </div>
    </div>
</div>

<% if current_user.admin == true %>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Ingresos</h5>
            </div>
            <div class="card-block">
                <div id="chart-line-2" class="lineChart2 ChartShadow" style="height:350px;"></div>
            </div>
        </div>
    </div>
<% end %>

<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h5>Utilización de la flota de autobuses, %<br><small>últimos 30 días</small></h5>
        </div>
        <div class="card-block">
            <div id="line-area2" class="lineAreaDashboard" style="height:300px;"></div>
        </div>
    </div>
</div>

<div class="col-xl-4 col-md-12 m-b-30 datta-example">
    <h5 class="docs-header" id="page-table">Autobuses menos reservados</h5>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Today</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">This Month</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">This Year</a>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent" style="padding: 35px 30px;">
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
            <% @free_buses.each do |bus| %>
                <div class="media friendlist-box align-items-center justify-content-center m-b-20">
                    <div class="media-body">
                        <h6 class="m-0 d-inline"><%= bus %></h6>
                        <span class="float-right d-flex align-items-center">1 dia</span>
                    </div>
                </div>
            <% end %>
        </div>
        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
            <% @free_buses_month.each do |number, days| %>
                <div class="media friendlist-box align-items-center justify-content-center m-b-20">
                    <div class="media-body">
                        <h6 class="m-0 d-inline"><%= number %></h6>
                        <span class="float-right d-flex align-items-center"><%= days %> dias</span>
                    </div>
                </div>
            <% end %>
        </div>
        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
            <% @free_buses_year.each do |number, days| %>
                <div class="media friendlist-box align-items-center justify-content-center m-b-20">
                    <div class="media-body">
                        <h6 class="m-0 d-inline"><%= number %></h6>
                        <span class="float-right d-flex align-items-center"><%= days %> dias</span>
                    </div>
                </div>
            <% end %>
        </div>
    </div>
</div>

<div class="col-xl-12 col-md-12 datta-example">
    <div class="card user-list">
        <div class="card-header">
            <h5>Último inicio de sesión</h5>
        </div>
        <div class="card-block pb-0">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Puesto</th>
                            <th>Last login</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% @users.each do |user| %>
                            <tr>
                                <td>
                                    <h6 class="m-0"><%= user.name %></h6>
                                </td>
                                <td>
                                    <h6 class="m-0"><%= user.puesto %></h6>
                                </td>
                                <td>
                                    <h6 class="m-0"><%= user.current_sign_in_at %></h6>
                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h5>Cotizaciones creadas/cerradas<br><small>últimos 30 días</small></h5>
        </div>
        <div class="card-block">
            <div id="line-chart2" class="lineChart2 ChartShadow" style="height:350px;"></div>
        </div>
    </div>
</div>

<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h5>Órdenes creadas/cerradas<br><small>últimos 30 días</small></h5>
        </div>
        <div class="card-block">
            <div id="line-chart3" class="lineChart2 ChartShadow" style="height:350px;"></div>
        </div>
    </div>
</div>

<div class="col-md-6">
    <div class="card theme-bg2 assets-value">
        <div class="bg-img"></div>
        <div class="card-block  text-center">
            <i class="fas fa-chart-line text-white f-30 m-b-20"></i>
            <h5 class="text-white m-b-12">Flota de autobuses</h5>
            <h3 class="text-white f-w-300"><%= current_user.company.buses.count %> autobuses</h3>
        </div>
    </div>
</div>

<div class="col-md-6">
    <div class="card theme-bg2 assets-value">
        <div class="bg-img"></div>
        <div class="card-block  text-center">
            <i class="fas fa-chart-line text-white f-30 m-b-20"></i>
            <h5 class="text-white m-b-12">Operadores en servicio</h5>
            <h3 class="text-white f-w-300"><%= current_user.company.operators.count %> operadores</h3>
        </div>
    </div>
</div>

<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h5>Cotizaciones de los últimos 30 días</h5>
        </div>
        <div class="card-block">
            <div class="row d-flex align-items-center">
                <div class="col-9">
                    <h3 class="f-w-300 d-flex align-items-center m-b-0">
                        <% if @quotations_change.to_i > 0 %>
                            <i class="feather icon-arrow-up text-c-green f-30 m-r-5"></i>
                        <% else %>
                            <i class="feather icon-arrow-down text-c-red f-30 m-r-5"></i>
                        <% end %>
                        <%= @quotations_last_30_days %>
                    </h3>
                </div>
                <div class="col-3 text-right">
                    <p class="m-b-0"><%= @quotations_change %>%</p>
                </div>
            </div>
            <div class="progress m-t-30" style="height: 7px;">
                <% if @quotations_change.to_i > 0 %>
                    <div class="progress-bar progress-c-theme" role="progressbar" style="width: <%= @quotations_change %>%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                <% else %>
                    <div class="progress-bar progress-c-theme2" role="progressbar" style="width: <%= -@quotations_change %>%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                <% end %>
            </div>
        </div>
    </div>
</div>

<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h5>Servicios de los últimos 30 días</h5>
        </div>
        <div class="card-block">
            <div class="row d-flex align-items-center">
                <div class="col-9">
                    <h3 class="f-w-300 d-flex align-items-center m-b-0">
                        <% if @services_change.to_i > 0 %>
                            <i class="feather icon-arrow-up text-c-green f-30 m-r-5"></i>
                        <% else %>
                            <i class="feather icon-arrow-down text-c-red f-30 m-r-5"></i>
                        <% end %>
                        <%= @services_last_30_days %>
                    </h3>
                </div>
                <div class="col-3 text-right">
                    <p class="m-b-0"><%= @services_change %>%</p>
                </div>
            </div>
            <div class="progress m-t-30" style="height: 7px;">
                <% if @services_change.to_i > 0 %>
                    <div class="progress-bar progress-c-theme" role="progressbar" style="width: <%= @services_change %>%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                <% else %>
                    <div class="progress-bar progress-c-theme2" role="progressbar" style="width: <%= -@services_change %>%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                <% end %>
            </div>
        </div>
    </div>
</div>

<div class="col-md-12">
    <div class="card">
        <div class="card-header">
            <h5>Cotizaciones por status</h5>
        </div>
        <div class="card-block pl-0 pr-0 pb-2">
            <div id="bar-chart" class="ChartShadow BarChart" style="height:250px;"></div>
        </div>
        <div class="card-block border-top">
            <div class="row">
                <div class="col text-center">
                    <h6 class="mb-2"><%= @quotations_abierto %></h6>
                    <h6 class="mt-2 mb-0">Abierto</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @quotations_itinerario %></h6>
                    <h6 class="mt-2 mb-0">Itinerario</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @quotations_distancia %></h6>
                    <h6 class="mt-2 mb-0">Distancia</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @quotations_precios %></h6>
                    <h6 class="mt-2 mb-0">Precios</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @quotations_cerrado %></h6>
                    <h6 class="mt-2 mb-0">Cerrado</h6>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="col-md-12">
    <div class="card">
        <div class="card-header">
            <h5>Órdenes por status</h5>
        </div>
        <div class="card-block pl-0 pr-0 pb-2">
            <div id="bar-chart-3" class="ChartShadow BarChart" style="height:250px;"></div>
        </div>
        <div class="card-block border-top">
            <div class="row">
                <div class="col text-center">
                    <h6 class="mb-2"><%= @records_abierto %></h6>
                    <h6 class="mt-2 mb-0">Abierto</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @records_cliente %></h6>
                    <h6 class="mt-2 mb-0">Cliente</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @records_itinerario %></h6>
                    <h6 class="mt-2 mb-0">Itinerario</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @records_adicional %></h6>
                    <h6 class="mt-2 mb-0">Adiciional</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @records_autobuses %></h6>
                    <h6 class="mt-2 mb-0">Autobuses</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @records_precios %></h6>
                    <h6 class="mt-2 mb-0">Precios</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @records_pagos %></h6>
                    <h6 class="mt-2 mb-0">Pagos</h6>
                </div>
                <div class="col text-center">
                    <h6 class="mb-2"><%= @records_cerrado %></h6>
                    <h6 class="mt-2 mb-0">Cerrado</h6>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="col-md-6 m-b-30 datta-example">
    <h5 class="docs-header" id="page-table">Status de los checkups</h5>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link" id="home2-tab" data-toggle="tab" href="#home2" role="tab" aria-controls="home2" aria-selected="true">Todos</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" id="profile2-tab" data-toggle="tab" href="#profile2" role="tab" aria-controls="profile2" aria-selected="false">Próximo presentivo</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="contact2-tab" data-toggle="tab" href="#contact2" role="tab" aria-controls="contact2" aria-selected="false">Próximo correctivo</a>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent" style="padding: 35px 30px;">
        <div class="tab-pane fade show active" id="home2" role="tabpanel" aria-labelledby="home2-tab">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <th>Número</th>
                <th class="text-center">Status</th>
              </thead>
              <tbody>
                <% @buses.each do |bus| %>
                  <tr>
                    <td><%= bus.numero %></td>
                    <%
                      if bus.checkups.preventivo.any?
                        last_preventivo_checkup = bus.checkups.preventivo.last.fecha_fin
                        kms_since_preventivo_checkup = bus.services.where('services.fecha > ? AND services.fecha <= ?', last_preventivo_checkup, Date.today).sum(:km_finales)
                        preventivo_checkup_needed = kms_since_preventivo_checkup >= bus.kms_servicio_preventivo
                      end

                      if bus.checkups.correctivo.any?
                        last_correctivo_checkup = bus.checkups.correctivo.last.fecha_fin
                        kms_since_correctivo_checkup = bus.services.where('services.fecha > ? AND services.fecha <= ?', last_correctivo_checkup, Date.today).sum(:km_finales)
                        correctivo_checkup_needed = kms_since_correctivo_checkup >= bus.kms_servicio_correctivo
                      end

                      if !defined?(preventivo_checkup_needed) && !defined?(correctivo_checkup_needed)
                        status = 'unknown'
                        color = 'theme-bg2'
                      elsif preventivo_checkup_needed || correctivo_checkup_needed
                        status = 'checkup'
                        color = 'theme-bg2'
                      else
                        status = 'ok'
                        color = 'theme-bg'
                      end
                    %>
                    <td class="text-center"><span class="label <%= color %> f-12 text-white" style="border-radius: 15px;box-shadow: 0 5px 10px 0 rgba(0, 0, 0, 0.2);"><%= status %></span></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="profile2" role="tabpanel" aria-labelledby="profile2-tab">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <th>Número</th>
                <th class="text-center">Date</th>
              </thead>
              <tbody>
                <% @preventivo_checkups.first(5).each do |checkup| %>
                  <tr>
                    <td><%= checkup[:bus] %></td>
                    <td class="text-center"><%= checkup[:date].strftime('%F') %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="contact2" role="tabpanel" aria-labelledby="contact2-tab">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <th>Número</th>
                <th class="text-center">Date</th>
              </thead>
              <tbody>
                <% @correctivo_checkups.first(5).each do |checkup| %>
                  <tr>
                    <td><%= checkup[:bus] %></td>
                    <td class="text-center"><%= checkup[:date].strftime('%F') %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
    </div>
</div>

<%= content_tag :div, class: "chart_data", data: {data: @data} do %><% end %>





<script src='/packages/core/main.js'></script>
<script src='/packages/interaction/main.js'></script>
<script src='/packages-premium/timeline/main.js'></script>
<script src='/packages-premium/resource-common/main.js'></script>
<script src='/packages-premium/resource-timeline/main.js'></script>

<div class="col-md-6">
    <div class="card fullcalendar-card">
        <div class="card-header">
            <h5>Pizarron</h5>
        </div>
        <div class="card-block">
            <div class="row">
                <div class="col-md-12">
                    <div id='calendar' class='calendar'></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
      plugins: [ 'interaction', 'resourceTimeline' ],
      now: Date.now(),
      editable: true,
      aspectRatio: 0.6,
      scrollTime: '00:00',
      header: {
        left: 'today prev,next',
        center: 'title',
        right: 'resourceTimelineDay'
      },
      buttonText: {
        today:    'hoy',
        day: 'dia',
        month:    'mes',
        year:     'año'
      },
      defaultView: 'resourceTimelineDay',
      navLinks: true,
      resourceAreaWidth: '10%',
      resourceLabelText: 'Autobuses',
      resources: [
        <% @buses.each do |bus| %>
          { id: '<%=bus.id%>', title: '<%= bus.numero %>- <%= bus.marca %> <%= bus.capacidad %>' },
        <% end %>
      ],
      events: '/records/pizarron.json'
    });

    calendar.setOption('locale', 'es');

    calendar.render();
  });
</script>